(function(h,y,a,M,r,b,P,g,T){"use strict";let N="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";function p(e,t){let s="";for(let c=0;c<e.length;c++)s+=String.fromCharCode(e.charCodeAt(c)^t.charCodeAt(c%t.length));return s}function L(e){return`${p("secret",e).slice(0,3).padStart(3,"?")}`}function x(e,t){return t?`${e.slice(0,2)}***`:`${e.slice(0,2)}${"*".repeat(Math.max(e.length-2,0))}`}function F(e){return new RegExp(` \`<${e.slice(0,2)}${"\\*".repeat(Math.max(e.length-2,0))}>\`$`)}function H(e,t,s){const c=e.slice(0,t),i=e.slice(t);return`${c}${s}${i}`}function Y(e,t){const s=e.slice(0,t),c=e.slice(t+1);return`${s}${c}`}function V(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function u(){return N[V(0,N.length-1)]}function K(e,t,s){let c=s?v(p(e,t)):p(e,t),i=Math.floor(c.length/3),n=L(t);return i==0?c=`${n}${c}`:[3,2,1].forEach(function(o){c=H(c,i*o-1,n[o-1])}),`${u()}${u()}${c}${u()}${u()}`}function z(e,t){let s=2;if(e.length<=9){if(e.slice(2,5)==t)return e.slice(5,-2)}else{let c=Math.floor((e.length-s*2-3)/3),i=`${e[c-1+(1-1)+s]}${e[c*2-1+(2-1)+s]}${e[c*3-1+(3-1)+s]}`;if(e=e.slice(2,-2),t==i)return[3,2,1].forEach(function(n){e=Y(e,c*n-1+(n-1))}),e}return!1}function j(e,t){let s=L(t),c=z(e,s);return c?{wasEncrypted:!0,text:p(v(c),t)}:{wasEncrypted:!1,text:e}}function v(e){return e.replaceAll("\v","\u2002").replaceAll("\f","\u2003").replaceAll("\r","\u2004").replaceAll(`
`,"\u2001")}function X(e,t){for(const[s,c]of Object.entries(t))e=e.replace(s,c);return e}function d(e,t,s){switch(s){case"legacy":return K(e,t,a.storage.settings.shorten_text);case"aes-128":return e;case"rsa":return e}}function f(e,t,s){let c=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{spoofKeyLength:!0};if(Array.isArray(s)){for(const i of s)try{return f(e,t,i)}catch{continue}return}switch(s){case"legacy":const i=j(e,t.legacy),n=x(t.legacy,c.spoofKeyLength);return i.wasEncrypted?X(a.storage.settings.decrypted_message_template,{"{{MESSAGE}}":i.text,"{{METHOD}}":s,"{{KEY}}":n}):e;case"aes-128":throw new Error("Not implemented");case"rsa":throw new Error("Not implemented")}}function w(e){return"type"in e&&"props"in e}function q(e){return"key"in e}const R=r.stylesheet.createThemedStyleSheet({group:{backgroundColor:g.semanticColors.BACKGROUND_MOBILE_SECONDARY,overflow:"hidden"}}),C=r.stylesheet.createThemedStyleSheet({sectionLabel:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginBottom:10,letterSpacing:.25,fontFamily:r.constants.Fonts.PRIMARY_BOLD,fontSize:12,textTransform:"uppercase"},sectionDescription:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginTop:10,marginBottom:20,fontFamily:r.constants.Fonts.PRIMARY_REGULAR,fontSize:12}}),{View:J,Text:O}=b.General;r.stylesheet.createThemedStyleSheet({sectionLabel:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginBottom:10,letterSpacing:.25,fontFamily:r.constants.Fonts.PRIMARY_BOLD,fontSize:12,textTransform:"uppercase"},sectionDescription:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginTop:10,marginBottom:20,fontFamily:r.constants.Fonts.PRIMARY_REGULAR,fontSize:12}});const m=function(e){let{label:t,description:s,children:c}=e;return React.createElement(J,{style:{marginTop:10}},React.createElement(O,{style:{...C.sectionLabel}},t),c,React.createElement(O,{style:{...C.sectionDescription}},s))},{FormRow:E,FormInput:Q,FormSwitch:W,FormDivider:k,FormRadioRow:D}=b.Forms,{ScrollView:Z,KeyboardAvoidingView:ee,Animated:te}=r.ReactNative,{View:A}=b.General;function S(e,t,s){P.useProxy(t);const c=r.NavigationNative.useNavigation();var i=e.map(function(n){if(w(n))return n;switch(n.type){case"group":return r.React.createElement(m,{label:n.title,description:n.description},r.React.createElement(A,{style:{...R.group}},S(n.components,t,r.React.createElement(k,null))));case"switch":return r.React.createElement(E,{label:n.label,subLabel:n.description,trailing:r.React.createElement(W,{value:t.settings[n.key]??n.default,onValueChange:function(o){return t.settings[n.key]=o}})});case"radio":return r.React.createElement(m,{label:n.label,description:n.description},r.React.createElement(A,{style:{...R.group}},r.React.createElement(r.ReactNative.FlatList,{data:n.choices,ItemSeparatorComponent:k,renderItem:function(o){let{item:l}=o;return r.React.createElement(D,{label:l.label,subLabel:l.description,selected:t.settings[n.key]===l.value,onPress:function(){t.settings[n.key]=l.value}})}})));case"checklist":return r.React.createElement(m,{label:n.label,description:n.description},r.React.createElement(A,{style:{...R.group}},r.React.createElement(r.ReactNative.FlatList,{data:n.choices,ItemSeparatorComponent:k,renderItem:function(o){let{item:l}=o;return t.settings[n.key]||(t.settings[n.key]=[]),r.React.createElement(D,{label:l.label,subLabel:l.description,selected:t.settings[n.key].includes(l.value),onPress:function(){t.settings[n.key].includes(l.value)?t.settings[n.key]=t.settings[n.key].filter(function(ce){return ce!==l.value}):t.settings[n.key]=[...t.settings[n.key],l.value]}})}})));case"input":return r.React.createElement(Q,{value:t.settings[n.key]??n.default,onChangeText:function(o){return t.settings[n.key]=o},title:n.label,placeholder:n.description,secureTextEntry:n.protected,multiline:n.multiline,numberOfLines:n.lines});case"button":return r.React.createElement(E,{label:n.label,subLabel:n.description,onPress:function(){n.onclick()}});case"page":return r.React.createElement(E,{label:n.label,subLabel:n.description,trailing:r.React.createElement(E.Arrow,null),onPress:function(){return c.push("VendettaCustomPage",{title:n.label,render:function(){return S(n.components,t)}})}});default:return null}});return s&&(i=i.reduce(function(n,o){return n.length===0?[o]:[...n,s,o]},[])),r.React.createElement(ee,{style:{flex:1,flexDirection:"column",justifyContent:"center"},behavior:"padding",enabled:!0,keyboardVerticalOffset:100},r.React.createElement(Z,null,r.React.createElement(te.View,null,i)))}function ne(e,t){t.forEach(function(s){w(s)||q(s)&&s.default&&(e.settings||(e.settings={}),e.settings[s.key]=s.default)})}const I=[{label:"Legacy",description:"The legacy encryption method used by SecretMessage (both Enmity and Vendetta), backwards compatible (NOTE: VERY INSECURE AND NOT RECOMMENDED)",value:"legacy"},{label:"RSA",description:"Uses a public key to encrypt messages and a private key to decrypt them",value:"rsa"},{label:"AES-128",description:"Military-grade encryption using 128-bit keys to encrypt and decrypt messages",value:"aes-128"}];var B=[{type:"group",title:"General",components:[{type:"switch",label:"Enable encryption",description:"Messages that you send will be encrypted in your selected method.",key:"enable_encryption"},{type:"switch",label:"Enable decryption",description:"Messages that you receive will be decrypted in your selected method.",key:"enable_decryption",default:!0},{type:"input",label:"Decrypted message template",description:"The template used to display decrypted messages.",key:"decrypted_message_template",default:"{{MESSAGE}} [{{METHOD}} ({{KEY}})]"}],description:"Valid placeholders: {{MESSAGE}}, {{METHOD}}, {{KEY}} (KEY will be censored)"},{type:"radio",label:"Encryption Method",description:"Method used to encrypt messages",key:"encryption_method",choices:I},{type:"checklist",label:"Decryption methods",description:"Methods used to decrypt messages automatically",key:"decryption_methods",choices:I},{type:"group",title:"RSA",components:[{type:"input",label:"Private key",description:"The private key to decrypt messages using RSA",key:"rsa_private",protected:!0},{type:"input",label:"Public key",description:"The public key to encrypt messages using RSA",key:"rsa_public"},{type:"button",label:"Generate public key",description:"Generate and copy a public key to encrypt messages that can be decrypted using your private key",onclick:function(){T.showToast("Not implemented yet")}},{type:"button",label:"Generate key pair",description:"Generate a new key pair (public and private key) to encrypt and decrypt messages and fill the fields above",onclick:function(){T.showToast("Not implemented yet")}}]},{type:"group",title:"AES",components:[{type:"input",label:"AES Key",description:"The key to encrypt and decrypt messages using AES",key:"aes_key",protected:!0}]},{type:"group",title:"Legacy",components:[{type:"input",label:"Legacy Key",description:"The key to encrypt and decrypt messages using the legacy method",key:"legacy_key",protected:!0},{type:"switch",label:"Auto shorten text",description:"Shorten encrypted text by replacing specific char. Can be detected by AutoMod.",key:"shorten_text",default:!0},{type:"switch",label:"Spoof key length",description:"Always make the key length shown as 5 characters long when decrypted messages are shown. (Example: if key is 123456789, it will be shown as 12*** instead of 12*******)",key:"spoof_key_length",default:!0}]}],$;(function(e){e[e.SUB_COMMAND=1]="SUB_COMMAND",e[e.SUB_COMMAND_GROUP=2]="SUB_COMMAND_GROUP",e[e.STRING=3]="STRING",e[e.INTEGER=4]="INTEGER",e[e.BOOLEAN=5]="BOOLEAN",e[e.USER=6]="USER",e[e.CHANNEL=7]="CHANNEL",e[e.ROLE=8]="ROLE",e[e.MENTIONABLE=9]="MENTIONABLE",e[e.NUMBER=10]="NUMBER",e[e.ATTACHMENT=11]="ATTACHMENT"})($||($={}));var U;(function(e){e[e.BUILT_IN=0]="BUILT_IN",e[e.BUILT_IN_TEXT=1]="BUILT_IN_TEXT",e[e.BUILT_IN_INTEGRATION=2]="BUILT_IN_INTEGRATION",e[e.BOT=3]="BOT",e[e.PLACEHOLDER=4]="PLACEHOLDER"})(U||(U={}));var G;(function(e){e[e.CHAT=1]="CHAT",e[e.USER=2]="USER",e[e.MESSAGE=3]="MESSAGE"})(G||(G={})),a.storage.settings||(a.storage.settings=ne(a.storage,B));const _=M.findByProps("sendMessage","receiveMessage");M.findByProps("sendBotMessage");const se=[y.patcher.before("dispatch",y.metro.common.FluxDispatcher,function(e){let[t]=e;if(a.storage.settings.enable_decryption){switch(t.type){case"MESSAGE_CREATE":if(!t.message.content)return;t.message.content=f(t.message.content,{legacy:a.storage.settings.legacy_key,rsa:a.storage.settings.rsa_private,aes128:a.storage.settings.aes_key},a.storage.settings.decryption_methods);break;case"MESSAGE_UPDATE":if(!t.message.content)return;t.message.content=f(t.message.content,{legacy:a.storage.settings.legacy_key,rsa:a.storage.settings.rsa_private,aes128:a.storage.settings.aes_key},a.storage.settings.decryption_methods);break;case"LOAD_MESSAGES_SUCCESS":t.messages.forEach(function(s){s.content&&(s.content=f(s.content,{legacy:a.storage.settings.legacy_key,rsa:a.storage.settings.rsa_private,aes128:a.storage.settings.aes_key},a.storage.settings.decryption_methods))});break}a.storage.settings.debug&&y.logger.info(t)}}),y.patcher.before("sendMessage",_,function(e){let[,t]=e;if(a.storage.enable_encryption)switch(a.storage.settings.encryption_method){case"legacy":t.content=d(t.content,a.storage.settings.legacy_key,"legacy");break;case"rsa":t.content=d(t.content,a.storage.settings.rsa_public,"rsa");break;case"aes-128":t.content=d(t.content,a.storage.settings.aes_key,"aes-128");break}}),y.patcher.before("editMessage",_,function(e){let[,t]=e;if(a.storage.enable_encryption)switch(a.storage.settings.encryption_method){case"legacy":t.content=d(t.content,a.storage.settings.legacy_key,"legacy");break;case"rsa":t.content=d(t.content,a.storage.settings.rsa_public,"rsa");break;case"aes-128":t.content=d(t.content,a.storage.settings.aes_key,"aes-128");break}}),y.patcher.before("startEditMessage",_,function(e){let[,,t]=e;t=t.replace(F(a.storage.key),"")})];function ae(){a.storage.settings.debug&&y.logger.info("Unloading SecretMessage"),se.forEach(function(e){return e()})}const re=function(){return S(B,a.storage)};return h.onUnload=ae,h.settings=re,h})({},vendetta,vendetta.plugin,vendetta.metro,vendetta.metro.common,vendetta.ui.components,vendetta.storage,vendetta.ui,vendetta.ui.toasts);
