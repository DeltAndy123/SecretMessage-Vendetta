(function(h,d,r,N,P,c,b,x,g,L){"use strict";let v="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";function p(e,t){let a="";for(let s=0;s<e.length;s++)a+=String.fromCharCode(e.charCodeAt(s)^t.charCodeAt(s%t.length));return a}function w(e){return`${p("secret",e).slice(0,3).padStart(3,"?")}`}function F(e,t){return t?`${e.slice(0,2)}***`:`${e.slice(0,2)}${"*".repeat(Math.max(e.length-2,0))}`}function H(e){return new RegExp(` \`<${e.slice(0,2)}${"\\*".repeat(Math.max(e.length-2,0))}>\`$`)}function Y(e,t,a){const s=e.slice(0,t),i=e.slice(t);return`${s}${a}${i}`}function V(e,t){const a=e.slice(0,t),s=e.slice(t+1);return`${a}${s}`}function K(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function u(){return v[K(0,v.length-1)]}function z(e,t,a){let s=a?C(p(e,t)):p(e,t),i=Math.floor(s.length/3),n=w(t);return i==0?s=`${n}${s}`:[3,2,1].forEach(function(o){s=Y(s,i*o-1,n[o-1])}),`${u()}${u()}${s}${u()}${u()}`}function X(e,t){let a=2;if(e.length<=9){if(e.slice(2,5)==t)return e.slice(5,-2)}else{let s=Math.floor((e.length-a*2-3)/3),i=`${e[s-1+(1-1)+a]}${e[s*2-1+(2-1)+a]}${e[s*3-1+(3-1)+a]}`;if(e=e.slice(2,-2),t==i)return[3,2,1].forEach(function(n){e=V(e,s*n-1+(n-1))}),e}return!1}function j(e,t){let a=w(t),s=X(e,a);return s?{wasEncrypted:!0,text:p(C(s),t)}:{wasEncrypted:!1,text:e}}function C(e){return e.replaceAll("\v","\u2002").replaceAll("\f","\u2003").replaceAll("\r","\u2004").replaceAll(`
`,"\u2001")}function J(e,t){for(const[a,s]of Object.entries(t))e=e.replace(a,s);return e}function y(e,t,a){switch(a){case"legacy":return z(e,t,r.storage.settings.shorten_text);case"aes-128":return e;case"rsa":return e}}function f(e,t,a){let s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{spoofKeyLength:!0};if(Array.isArray(a)){for(const i of a)try{return f(e,t,i)}catch{continue}return}switch(a){case"legacy":const i=j(e,t.legacy),n=F(t.legacy,s.spoofKeyLength);return i.wasEncrypted?J(r.storage.settings.decrypted_message_template,{"{{MESSAGE}}":i.text,"{{METHOD}}":a,"{{KEY}}":n}):e;case"aes-128":throw new Error("Not implemented");case"rsa":throw new Error("Not implemented")}}function O(e){return"type"in e&&"props"in e}function q(e){return"key"in e}const m=c.stylesheet.createThemedStyleSheet({group:{backgroundColor:g.semanticColors.BACKGROUND_MOBILE_SECONDARY,overflow:"hidden"}}),D=c.stylesheet.createThemedStyleSheet({sectionLabel:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginBottom:10,letterSpacing:.25,fontFamily:c.constants.Fonts.PRIMARY_BOLD,fontSize:12,textTransform:"uppercase"},sectionDescription:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginTop:10,marginBottom:20,fontFamily:c.constants.Fonts.PRIMARY_REGULAR,fontSize:12}}),{View:Q,Text:I}=b.General;c.stylesheet.createThemedStyleSheet({sectionLabel:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginBottom:10,letterSpacing:.25,fontFamily:c.constants.Fonts.PRIMARY_BOLD,fontSize:12,textTransform:"uppercase"},sectionDescription:{color:g.semanticColors.HEADER_SECONDARY,paddingLeft:"5.5%",paddingRight:10,marginTop:10,marginBottom:20,fontFamily:c.constants.Fonts.PRIMARY_REGULAR,fontSize:12}});const k=function(e){let{label:t,description:a,children:s}=e;return React.createElement(Q,{style:{marginTop:10}},React.createElement(I,{style:{...D.sectionLabel}},t),s,React.createElement(I,{style:{...D.sectionDescription}},a))},{FormRow:E,FormInput:W,FormSwitch:Z,FormDivider:R,FormRadioRow:B}=b.Forms,{ScrollView:ee,KeyboardAvoidingView:te,Animated:ne}=c.ReactNative,{View:A}=b.General;function S(e,t,a){x.useProxy(t);const s=c.NavigationNative.useNavigation();var i=e.map(function(n){if(O(n))return n;switch(n.type){case"group":return c.React.createElement(k,{label:n.title,description:n.description},c.React.createElement(A,{style:{...m.group}},S(n.components,t,c.React.createElement(R,null))));case"switch":return c.React.createElement(E,{label:n.label,subLabel:n.description,trailing:c.React.createElement(Z,{value:t.settings[n.key]??n.default,onValueChange:function(o){return t.settings[n.key]=o}})});case"radio":return c.React.createElement(k,{label:n.label,description:n.description},c.React.createElement(A,{style:{...m.group}},c.React.createElement(c.ReactNative.FlatList,{data:n.choices,ItemSeparatorComponent:R,renderItem:function(o){let{item:l}=o;return c.React.createElement(B,{label:l.label,subLabel:l.description,selected:t.settings[n.key]===l.value,onPress:function(){t.settings[n.key]=l.value}})}})));case"checklist":return c.React.createElement(k,{label:n.label,description:n.description},c.React.createElement(A,{style:{...m.group}},c.React.createElement(c.ReactNative.FlatList,{data:n.choices,ItemSeparatorComponent:R,renderItem:function(o){let{item:l}=o;return t.settings[n.key]||(t.settings[n.key]=[]),c.React.createElement(B,{label:l.label,subLabel:l.description,selected:t.settings[n.key].includes(l.value),onPress:function(){t.settings[n.key].includes(l.value)?t.settings[n.key]=t.settings[n.key].filter(function(oe){return oe!==l.value}):t.settings[n.key]=[...t.settings[n.key],l.value]}})}})));case"input":return c.React.createElement(W,{value:t.settings[n.key]??n.default,onChangeText:function(o){return t.settings[n.key]=o},title:n.label,placeholder:n.description,secureTextEntry:n.protected,multiline:n.multiline,numberOfLines:n.lines});case"button":return c.React.createElement(E,{label:n.label,subLabel:n.description,onPress:function(){n.onclick()}});case"page":return c.React.createElement(E,{label:n.label,subLabel:n.description,trailing:c.React.createElement(E.Arrow,null),onPress:function(){return s.push("VendettaCustomPage",{title:n.label,render:function(){return S(n.components,t)}})}});default:return null}});return a&&(i=i.reduce(function(n,o){return n.length===0?[o]:[...n,a,o]},[])),c.React.createElement(te,{style:{flex:1,flexDirection:"column",justifyContent:"center"},behavior:"padding",enabled:!0,keyboardVerticalOffset:100},c.React.createElement(ee,null,c.React.createElement(ne.View,null,i)))}function se(e,t){const a=function(s){if(!O(s)){if(s.type==="group")return s.components.forEach(a);if(q(s)){if(s.default==null)switch(s.type){case"button":s.default=function(){};break;case"checklist":s.default=[];break;case"input":s.default="";break;case"radio":s.default=s.choices[0].value;break;case"switch":s.default=!1;break}e[s.key]=s.default}}};return t.forEach(a),e}const $=[{label:"Legacy",description:"The legacy encryption method used by SecretMessage (both Enmity and Vendetta), backwards compatible (NOTE: VERY INSECURE AND NOT RECOMMENDED)",value:"legacy"},{label:"RSA",description:"Uses a public key to encrypt messages and a private key to decrypt them",value:"rsa"},{label:"AES-128",description:"Military-grade encryption using 128-bit keys to encrypt and decrypt messages",value:"aes-128"}];var U=[{type:"group",title:"General",components:[{type:"switch",label:"Enable encryption",description:"Messages that you send will be encrypted in your selected method.",key:"enable_encryption"},{type:"switch",label:"Enable decryption",description:"Messages that you receive will be decrypted in your selected method.",key:"enable_decryption"},{type:"input",label:"Decrypted message template",description:"The template used to display decrypted messages.",key:"decrypted_message_template",default:"{{MESSAGE}} [{{METHOD}} ({{KEY}})]"}],description:"Valid placeholders: {{MESSAGE}}, {{METHOD}}, {{KEY}} (KEY will be censored)"},{type:"radio",label:"Encryption Method",description:"Method used to encrypt messages",key:"encryption_method",choices:$},{type:"checklist",label:"Decryption methods",description:"Methods used to decrypt messages automatically",key:"decryption_methods",choices:$},{type:"group",title:"RSA",components:[{type:"input",label:"Private key",description:"The private key to decrypt messages using RSA",key:"rsa_private",protected:!0},{type:"input",label:"Public key",description:"The public key to encrypt messages using RSA",key:"rsa_public"},{type:"button",label:"Generate public key",description:"Generate and copy a public key to encrypt messages that can be decrypted using your private key",onclick:function(){L.showToast("Not implemented yet")}},{type:"button",label:"Generate key pair",description:"Generate a new key pair (public and private key) to encrypt and decrypt messages and fill the fields above",onclick:function(){L.showToast("Not implemented yet")}}]},{type:"group",title:"AES",components:[{type:"input",label:"AES Key",description:"The key to encrypt and decrypt messages using AES",key:"aes_key",protected:!0}]},{type:"group",title:"Legacy",components:[{type:"input",label:"Legacy Key",description:"The key to encrypt and decrypt messages using the legacy method",key:"legacy_key",protected:!0},{type:"switch",label:"Auto shorten text",description:"Shorten encrypted text by replacing specific char. Can be detected by AutoMod.",key:"shorten_text",default:!0},{type:"switch",label:"Spoof key length",description:"Always make the key length shown as 5 characters long when decrypted messages are shown. (Example: if key is 123456789, it will be shown as 12*** instead of 12*******)",key:"spoof_key_length",default:!0}]}],G;(function(e){e[e.SUB_COMMAND=1]="SUB_COMMAND",e[e.SUB_COMMAND_GROUP=2]="SUB_COMMAND_GROUP",e[e.STRING=3]="STRING",e[e.INTEGER=4]="INTEGER",e[e.BOOLEAN=5]="BOOLEAN",e[e.USER=6]="USER",e[e.CHANNEL=7]="CHANNEL",e[e.ROLE=8]="ROLE",e[e.MENTIONABLE=9]="MENTIONABLE",e[e.NUMBER=10]="NUMBER",e[e.ATTACHMENT=11]="ATTACHMENT"})(G||(G={}));var _;(function(e){e[e.BUILT_IN=0]="BUILT_IN",e[e.BUILT_IN_TEXT=1]="BUILT_IN_TEXT",e[e.BUILT_IN_INTEGRATION=2]="BUILT_IN_INTEGRATION",e[e.BOT=3]="BOT",e[e.PLACEHOLDER=4]="PLACEHOLDER"})(_||(_={}));var T;(function(e){e[e.CHAT=1]="CHAT",e[e.USER=2]="USER",e[e.MESSAGE=3]="MESSAGE"})(T||(T={})),r.storage.settings||(r.storage.settings=se({},U));const M=N.findByProps("sendMessage","receiveMessage"),{sendBotMessage:ae}=N.findByProps("sendBotMessage"),re=[d.patcher.before("dispatch",d.metro.common.FluxDispatcher,function(e){let[t]=e;if(r.storage.settings&&r.storage.settings.enable_decryption){switch(t.type){case"MESSAGE_CREATE":if(!t.message.content)return;t.message.content=f(t.message.content,{legacy:r.storage.settings.legacy_key,rsa:r.storage.settings.rsa_private,aes128:r.storage.settings.aes_key},r.storage.settings.decryption_methods);break;case"MESSAGE_UPDATE":if(!t.message.content)return;t.message.content=f(t.message.content,{legacy:r.storage.settings.legacy_key,rsa:r.storage.settings.rsa_private,aes128:r.storage.settings.aes_key},r.storage.settings.decryption_methods);break;case"LOAD_MESSAGES_SUCCESS":t.messages.forEach(function(a){a.content&&(a.content=f(a.content,{legacy:r.storage.settings.legacy_key,rsa:r.storage.settings.rsa_private,aes128:r.storage.settings.aes_key},r.storage.settings.decryption_methods))});break}r.storage.settings.debug&&d.logger.info(t)}}),d.patcher.before("sendMessage",M,function(e){let[,t]=e;if(r.storage.settings.enable_encryption)switch(r.storage.settings.encryption_method){case"legacy":t.content=y(t.content,r.storage.settings.legacy_key,"legacy");break;case"rsa":t.content=y(t.content,r.storage.settings.rsa_public,"rsa");break;case"aes-128":t.content=y(t.content,r.storage.settings.aes_key,"aes-128");break}}),d.patcher.before("editMessage",M,function(e){let[,t]=e;if(r.storage.settings.enable_encryption)switch(r.storage.settings.encryption_method){case"legacy":t.content=y(t.content,r.storage.settings.legacy_key,"legacy");break;case"rsa":t.content=y(t.content,r.storage.settings.rsa_public,"rsa");break;case"aes-128":t.content=y(t.content,r.storage.settings.aes_key,"aes-128");break}}),d.patcher.before("startEditMessage",M,function(e){let[,,t]=e;t=t.replace(H(r.storage.settings.key),"")}),P.registerCommand({name:"test",displayName:"test",description:"test",displayDescription:"test",options:[],applicationId:"",inputType:_.BUILT_IN_TEXT,type:T.CHAT,execute:function(e,t){ae(t.channel.id,JSON.stringify(r.storage.settings,null,2))}})];function ce(){r.storage.settings.debug&&d.logger.info("Unloading SecretMessage"),re.forEach(function(e){return e()})}const ie=function(){return S(U,r.storage)};return h.onUnload=ce,h.settings=ie,h})({},vendetta,vendetta.plugin,vendetta.metro,vendetta.commands,vendetta.metro.common,vendetta.ui.components,vendetta.storage,vendetta.ui,vendetta.ui.toasts);
